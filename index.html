<!DOCTYPE html>
<html lang="si">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Expense Tracker Pro</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background-color: #f0f2f5; margin: 0; padding: 20px; display: flex; justify-content: center; }
        .container { background: white; padding: 25px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); width: 100%; max-width: 450px; }
        h2 { text-align: center; color: #333; margin-bottom: 20px; }
        
        /* Form Styles */
        input, button, select { width: 100%; padding: 12px; margin-bottom: 15px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 16px; }
        button { background-color: #4a90e2; color: white; border: none; font-weight: bold; cursor: pointer; }
        button:hover { background-color: #357abd; }

        /* Switch Styles */
        .switch-field { display: flex; margin-bottom: 20px; overflow: hidden; }
        .switch-field input { display: none; }
        .switch-field label { flex: 1; text-align: center; padding: 12px; background-color: #e4e4e4; color: #555; cursor: pointer; border: 1px solid rgba(0,0,0,0.1); transition: all 0.2s; }
        .switch-field label:first-of-type { border-radius: 8px 0 0 8px; }
        .switch-field label:last-of-type { border-radius: 0 8px 8px 0; }
        .switch-field input:checked + label.income-lbl { background-color: #2ecc71; color: white; }
        .switch-field input:checked + label.expense-lbl { background-color: #e74c3c; color: white; }

        /* Summary Section */
        .summary-box { display: flex; gap: 10px; margin-bottom: 20px; text-align: center; }
        .card { flex: 1; padding: 10px; border-radius: 8px; color: white; }
        .inc-card { background-color: #2ecc71; }
        .exp-card { background-color: #e74c3c; }
        .card h3 { margin: 0; font-size: 14px; opacity: 0.9; }
        .card span { font-size: 18px; font-weight: bold; }

        /* Filter Section */
        .filter-section { margin-bottom: 15px; border-top: 2px solid #f0f0f0; padding-top: 15px; }
        .filter-section label { font-size: 14px; color: #666; font-weight: bold; display: block; margin-bottom: 5px; }

        /* Data List */
        .data-list { list-style: none; padding: 0; max-height: 300px; overflow-y: auto; }
        .data-item { background: #f9f9f9; padding: 10px; margin-bottom: 8px; border-radius: 6px; display: flex; justify-content: space-between; align-items: center; border-left: 5px solid #ddd; }
        .data-item.inc { border-left-color: #2ecc71; }
        .data-item.exp { border-left-color: #e74c3c; }
        .item-details { display: flex; flex-direction: column; }
        .item-date { font-size: 11px; color: #888; }
        .item-desc { font-weight: 600; color: #333; }
        .item-amount { font-weight: bold; }
        .inc .item-amount { color: #2ecc71; }
        .exp .item-amount { color: #e74c3c; }
        
        #loading { text-align: center; color: #666; font-style: italic; display: none; }
    </style>
</head>
<body>

<div class="container">
    <h2>මුදල් කළමනාකරණය</h2>
    
    <form name="submit-to-google-sheet">
        <div class="switch-field">
            <input type="radio" id="radio-income" name="Type" value="Income" checked/>
            <label for="radio-income" class="income-lbl">ආදායම්</label>
            <input type="radio" id="radio-expense" name="Type" value="Expense" />
            <label for="radio-expense" class="expense-lbl">වියදම්</label>
        </div>
        <input type="text" name="Description" placeholder="විස්තරය (Short Text)" required>
        <input type="number" name="Amount" placeholder="මුදල (0.00)" required>
        <button type="submit" id="btnSubmit">දත්ත ඇතුලත් කරන්න</button>
    </form>
    <div id="status" style="text-align: center; margin-bottom: 10px;"></div>

    <div class="filter-section">
        <label>මාසය තෝරන්න:</label>
        <select id="monthSelect" onchange="filterData()">
            <option value="all">Loading...</option>
        </select>
        
        <div class="summary-box">
            <div class="card inc-card">
                <h3>මුළු ආදායම</h3>
                <span id="totalIncome">0.00</span>
            </div>
            <div class="card exp-card">
                <h3>මුළු වියදම</h3>
                <span id="totalExpense">0.00</span>
            </div>
        </div>

        <p id="loading">දත්ත ලබා ගනිමින් පවතී...</p>
        <ul class="data-list" id="dataList">
            </ul>
    </div>
</div>

<script>
    const scriptURL = 'https://script.google.com/macros/s/AKfycbx29xmCuoWfRFkDbqcMw-EtG_EytYeC9V6oua6wDIVDrWNs-_pukDMTA9Vl4-2fu5IL0Q/exec';
    
    const form = document.forms['submit-to-google-sheet'];
    const statusMsg = document.getElementById('status');
    const monthSelect = document.getElementById('monthSelect');
    const dataList = document.getElementById('dataList');
    const loadingMsg = document.getElementById('loading');

    let allData = []; // Store fetched data

    // 1. Submit Data
    form.addEventListener('submit', e => {
      e.preventDefault();
      const btn = document.getElementById('btnSubmit');
      btn.disabled = true;
      btn.innerText = "Sending...";
      
      fetch(scriptURL, { method: 'POST', body: new FormData(form)})
        .then(response => {
            statusMsg.innerHTML = "<span style='color: green;'>සාර්ථකයි!</span>";
            form.reset();
            btn.disabled = false;
            btn.innerText = "දත්ත ඇතුලත් කරන්න";
            setTimeout(() => { statusMsg.innerHTML = ""; }, 3000);
            fetchData(); // Refresh list after submit
        })
        .catch(error => {
            statusMsg.innerHTML = "<span style='color: red;'>දෝෂයක්!</span>";
            btn.disabled = false;
        });
    });

    // 2. Fetch Data (Read from Sheet)
    function fetchData() {
        loadingMsg.style.display = 'block';
        fetch(scriptURL)
            .then(res => res.json())
            .then(data => {
                allData = data.reverse(); // Show latest first
                populateMonthDropdown();
                filterData(); // Initial render
                loadingMsg.style.display = 'none';
            })
            .catch(err => console.error(err));
    }

    // 3. Populate Month Dropdown
    function populateMonthDropdown() {
        const months = new Set();
        allData.forEach(item => {
            // item.Date format is "yyyy-MM-dd HH:mm" -> get "yyyy-MM"
            let m = item.Date.substring(0, 7); 
            months.add(m);
        });

        // Convert to array and sort
        const sortedMonths = Array.from(months).sort().reverse();
        
        let options = '';
        sortedMonths.forEach(m => {
            options += `<option value="${m}">${m}</option>`;
        });
        
        // Save current selection if exists, else select latest
        const currentVal = monthSelect.value;
        monthSelect.innerHTML = options;
        if(sortedMonths.includes(currentVal)) {
             monthSelect.value = currentVal;
        }
    }

    // 4. Filter and Render Data
    function filterData() {
        const selectedMonth = monthSelect.value;
        dataList.innerHTML = "";
        
        let totalInc = 0;
        let totalExp = 0;

        const filtered = allData.filter(item => item.Date.startsWith(selectedMonth));

        filtered.forEach(item => {
            const amount = parseFloat(item.Amount);
            const isInc = item.Type === 'Income';
            
            // Calculate Totals
            if(isInc) totalInc += amount; else totalExp += amount;

            // Create List Item
            const li = document.createElement('li');
            li.className = `data-item ${isInc ? 'inc' : 'exp'}`;
            li.innerHTML = `
                <div class="item-details">
                    <span class="item-desc">${item.Description}</span>
                    <span class="item-date">${item.Date}</span>
                </div>
                <span class="item-amount">${isInc ? '+' : '-'} ${amount.toFixed(2)}</span>
            `;
            dataList.appendChild(li);
        });

        // Update Summary
        document.getElementById('totalIncome').innerText = totalInc.toFixed(2);
        document.getElementById('totalExpense').innerText = totalExp.toFixed(2);
    }

    // Load data on page open
    fetchData();

</script>

</body>
</html>
